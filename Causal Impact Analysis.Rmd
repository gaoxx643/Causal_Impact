---
title: "Causal Impact Analysis"
author: "Jeremy Gao"
date: "2018/6/7"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, error = F, warning = F)
```

## Set up working directory and load the file

```{r}
require("CausalImpact")
require("reshape2")
require("dplyr")
require("ggplot2")
require("GGally")
setwd("~/Desktop/Python/causal_impact")
df = read.table(file='causal_impact_data.csv', sep = ",", header = T)
head(df, n=10)
```

##  A bit data wrangling 
```{r}
df$city_group = ifelse(df$city_id==17, 'chengdu', ifelse(df$city_id==18, 'chongqing', 'others')) #group cities into 3 groups
df = df[, !colnames(df)%in%c("city_id")] # drop city_id
df_reshape = melt(data=df, id.vars = c("dateid", "city_group", "product_category"), measure.vars = c("request", "answer", "finish", "total_gmv", "needs"))
head(df_reshape, n=5)
```

## Check correlations betwen different business categories
```{r}
df_decast = dcast(df_reshape, dateid~city_group+product_category+variable, fun.aggregate = sum)
head(df_decast)
cor(df_decast$chengdu_3_finish, df_decast[, 2:36]) # cor matrics between reques for special car with other requests/finihes in chengdu 
```

## According to the covarites, finished orders in chengdu is highly related to requests, needs from chengdu and finished orders from chongqing
```{r}
df_plot = melt(df_decast[, c("dateid", "chengdu_1_request", "chengdu_1_needs", "chengdu_3_needs", "chongqing_3_finish", "chengdu_3_finish")], id.vars = "dateid")
head(df_plot)
df_plot$dateid = as.Date(df_plot$dateid)
ggplot(df_plot, aes(x=dateid, y=value, color=variable)) + geom_line()
```

## model 1: simulate a control group by synthesizing requests, finish from other cities and other business segments
```{r}
# simulate with highly related variables
df_decast$dateid = as.Date(df_decast$dateid)
df_causal_impact_1 = subset(df_decast, select=c(chengdu_3_finish, chengdu_1_request, chengdu_1_needs, chengdu_3_needs, chongqing_3_finish))

causal_model1_data = zoo(df_causal_impact_1, df_decast$dateid)

pre_period = as.Date(c("2018-03-01", "2018-04-25")) #data prior to 4/25 is much cleaner
post_period = as.Date(c("2018-05-15", "2018-06-03")) # events launch time

impact1 = CausalImpact(causal_model1_data, pre_period, post_period, model.args=list(prior.level.sd=0.1, nseasons=7, season.duration=1), alpha = 0.05)
plot(impact1)
summary(impact1)
```

## model2: simulate control group with finish orders from chongqing, assuming requests of chengdu are impacted by treatment as well
```{r}
# simulate only with chongqing, but cannot totally rule out the impact due to different weather
df_causal_impact_2 = subset(df_decast, select = c(chengdu_3_finish, chongqing_3_finish))
causal_model2_data = zoo(df_causal_impact_2, df_decast$dateid)

impact2 = CausalImpact(causal_model2_data, pre_period, post_period, model.args = list(prior.level.sd=0.1, nseasons=7, season.duration=1), alpha = 0.05)

plot(impact2)
summary(impact2)

# find the date when actuals and forecasts diverge and replace the data with previous averages. in fact, the DID might not due to weather but stragety change
ggplot(df_plot[df_plot$variable%in%c("dateid", "chongqing_3_finish", "chengdu_3_finish"), ], aes(x=dateid, y=value, color=variable)) + geom_line() + scale_x_date(date_labels = "%y/%m/%d", date_breaks="3 day")+theme(axis.text.x = element_text(angle = 90))

# focusing on certain dates
ggplot(df_plot[df_plot$variable%in%c("dateid", "chongqing_3_finish", "chengdu_3_finish") & df_plot$dateid>="2018-05-01", ], aes(x=dateid, y=value, color=variable)) + geom_line() + scale_x_date(date_labels = "%y/%m/%d", date_breaks = "3 day") + theme(axis.text.x = element_text(angle = 90))
#??????5???7-10????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????5???5??????9??????13?????????????????????????????????

#???????????????????????????????????????????????????
#????????????????????????????????????????????????????????????????????????
```

## model 3: assuming big weather difference for chengdu and chongqing, so using chengdu's data only to simulate control group
```{r}
# more reliable to combine requests from both express and premium
df_causal_impact_3 = subset(df_decast, select = c(chengdu_3_finish, chengdu_3_needs, chengdu_1_needs))
causal_model3_data = zoo(df_causal_impact_3, df_decast$dateid)

post_period = as.Date(c("2018-05-02", "2018-06-03")) # treaments launch time

impact3 = CausalImpact(causal_model3_data, pre_period, post_period, model.args = list(prior.level.sd=0.1, nseasons=7, season.duration=1), alpha = 0.05)

plot(impact3)
summary(impact3)
```

